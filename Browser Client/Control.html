<!DOCTYPE html>
    <head>
        <link rel="shortcut icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIBAMAAAA2IaO4AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAwUExURZuYmp6amqKfn6GeoKajo6WgoamlpqunqK6rq66qq66rrLGurrKvsbWytLWxsri1tmaDmxsAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAtSURBVBjTY7j///9/BkZBQUEIyzTEVYnh3N1z7xjSy9JcGFbtntHFsLw8LQ0AfZASPN7lR7sAAAAASUVORK5CYII=">
        <style>
        body {font-family: Arial;}
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #ccc;
        }
        
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        </style>
        <script>
            const NR_OF_TIMINGS = 6;
            const NR_OF_MESSAGES = 10;

            var currentValue;
            var startup;

            var stateMessage;
            var messages;
            var timings;
            var timingSeekbars = [];
			
			var seekbar;
			var seekbarValue;			

            var longrequest = false;
            var failureCounter = 0;

            var timingButton;
            var setButton;
            var upButton;
            var downButton;
            var autoButton;

            var queue = [];
            var currentRequest = null;

            function disableGui(){
                for (var i = 0; i < timings.children.length; i++) {
                    for(var j = 0; j < timings.children[i].children.length; j++) {
                        timings.children[i].children[j].disabled = true;
                    }
                }

                timingButton.disabled = true;
                setButton.disabled = true;
                upButton.disabled = true;
                downButton.disabled = true;
                autoButton.disabled = true;

                seekbar.disabled = true;
            };

            function enableGUI(){
                for (var i = 0; i < timings.children.length; i++) {
                    for(var j = 0; j < timings.children[i].children.length; j++) {
                        timings.children[i].children[j].disabled = false;
                    }
                }

                timingButton.disabled = false;
                setButton.disabled = false;
                upButton.disabled = false;
                downButton.disabled = false;
                autoButton.disabled = false;

                seekbar.disabled = false;
            };

            function dequeue() {
                if (queue.length > 0) {
                    stateMessage.innerText = "Syncing in progress...";

                    currentRequest = queue.shift();
                    currentRequest.request.timeout = 12000;

                    if (currentRequest.request.onload == null) {
                        currentRequest.request.onload = function() {
                            if (this.response == null || this.response == "") {
                                location.reload();
                            }

                            try {
                                var responseObject = JSON.parse(this.response);
                                parseGenericResponse(responseObject["G"]);
                            }
                            catch(e) {
                               location.reload();
                            }

                            currentRequest = null;
                            failureCounter = 0;
                            dequeue();
                        }

                        disableGui();
                    }

                    currentRequest.request.ontimeout = function() {
                        stateMessage.innerText = "The server is not available.";
                        disableGui();
                        failureCounter++;
                        currentRequest = null;
                        dequeue();
                    }

                    currentRequest.request.onerror = function() {
                        stateMessage.innerText = "Error while communicating.";
                        disableGui();
                        failureCounter++;
                        currentRequest = null;
                        dequeue();
                    }

                    currentRequest.request.onreadystatechange = function() {
                        if (this.readyState !== 4) {
                            return;
                        }

                        if (this.status == "302") {
                            location.reload();
                        }
                    }

                    if (currentRequest.body == null) {
                        currentRequest.request.open("GET", currentRequest.path);
                        currentRequest.request.send();
                    }
                    else {
                        currentRequest.request.open("POST", currentRequest.path);
                        currentRequest.request.send(currentRequest.body);
                    }                
                }
            };
            
            function enqueue(requestObject) {
                queue.push(requestObject);
                if(queue.length == 1 && currentRequest == null){
                    dequeue();
                }
            };

            function parseMessages(messageObject) {
                startup.innerText = messageObject["S"];

                for (var key in messageObject["M"]) {
                    var keyInt = parseInt(key);
                    var formattedMessage = getFormattedMessage(messageObject["M"][key]["T"], messageObject["M"][key]["R"], messageObject["M"][key]["A"]);

                    messages.childNodes[keyInt+2].innerHTML = `<td style="width: 16%; text-align: center">${keyInt+1}.</td>
                            <td style="width: 32%; text-align: left">${formattedMessage}</td>
                            <td style="width: 42%; text-align: left">${messageObject["M"][key]["D"]}</td>`;                
                }
            }

            function parseTiming(timingsObject) {
                for (var key in timingsObject) {
                    var timingObject = timingsObject[key];
                    var keyInt = parseInt(key);

                    var activeBox = document.getElementById(`toggle${keyInt}`);
                    activeBox.checked = timingObject["A"];

                    var timeSet = document.getElementById(`timeSet${keyInt}`);

                    var hourString = String(timingObject["H"]);
                    hourString = hourString.length == 1 ? "0" + hourString : hourString;

                    var minuteString = String(timingObject["M"]);
                    minuteString = minuteString.length == 1 ? "0" + minuteString : minuteString;

                    timeSet.value = hourString + ":" + minuteString;

                    var seekbar = document.getElementById(`tseekbar${keyInt}`);
                    seekbar.value = timingObject["V"];

                    var seekbarText = document.getElementById(`seekbarValue${keyInt}`);
                    seekbarText.innerText = timingObject["V"];

                    for(var i = 0; i < 7; i++) {
                        var dayBox = document.getElementById(`day${keyInt}_${i}`);

                        if (timingObject["D"][i] == "T") {
                            dayBox.checked = true;    
                        }   
                        else{
                            dayBox.checked = false;
                        }
                    }
                }
            }

            function postUR() {
                var zeroObject = new Object();
                var zeroJObject = {"Z" : "up"};
                zeroObject.request = new XMLHttpRequest();
                zeroObject.path = "/Z";
                zeroObject.body = JSON.stringify(zeroJObject);
                enqueue(zeroObject);
            };
            function postDR() {
                var zeroObject = new Object();
                var zeroJObject = {"Z" : "down"};
                zeroObject.request = new XMLHttpRequest();
                zeroObject.path = "./Z";
                zeroObject.body = JSON.stringify(zeroJObject);
                enqueue(zeroObject);
            };        
            function postAR() {
                var zeroObject = new Object();
                var zeroJObject = {"Z" : "find"};
                zeroObject.request = new XMLHttpRequest();
                zeroObject.path = "./Z";
                zeroObject.body = JSON.stringify(zeroJObject);
                enqueue(zeroObject);
            };

            function createStatusRequestObject() {
                var statusRequestObject = new Object();

                var statusRequest = new XMLHttpRequest();
                statusRequest.onload = function() {
                    if (this.response == null || this.response == "") {
                        location.reload();
                    }

                    try {
                        var responseObject = JSON.parse(this.response);
                        parseGenericResponse(responseObject["G"]);
                    }
                    catch(e) {
                        location.reload();
                    }

                    currentRequest = null;

                    if (longrequest) {
                        stateMessage.innerText = "Syncing in progress...";
                        disableGui();
                    }

                    dequeue();
                };

                statusRequestObject.request = statusRequest;
                statusRequestObject.path = "/S";
                statusRequestObject.body = null;

                return statusRequestObject;
            };

            function getStatus() {
                var statusRequestObject = createStatusRequestObject();
                enqueue(statusRequestObject);
            }

            function parseGenericResponse(responseObject) {
                var retrytime = responseObject["R"];
                retrytime = parseInt(retrytime);

                if (retrytime > 0 && queue.length == 0) {
                    setTimeout(getStatus, (retrytime * 1000));
                    return;
                }
                else if (retrytime > 0 && queue.length > 0) {
                    return;
                }
                else if (queue.length == 0) {
                    enableGUI();
                }

                longrequest = false;
                var value = parseInt(responseObject["V"]);
                seekbarValue.innerText = value;
                seekbar.value = value;

                stateMessage.innerText = "The server is available!";
                currentValue.innerText = value;

                parseMessages(responseObject["M"]);            
            };
            
            function parseDump(dump) {
                var dumpObject = JSON.parse(dump);
                var genericObject = dumpObject["G"];
                parseGenericResponse(genericObject);
                var timingObject = dumpObject["T"];
                parseTiming(timingObject);
            }
            
            function sendDumpRequest() {
                var dumpRequest = new XMLHttpRequest();
                dumpRequest.onload = function() {
                    parseDump(dumpRequest.response);
                    currentRequest = null;
                    enableGUI();
                    dequeue();
                };

                var dumpRequestObject = new Object();
                dumpRequestObject.request = dumpRequest;
                dumpRequestObject.path = "/D";
                dumpRequestObject.body = null;
                enqueue(dumpRequestObject);
            }
            
            function postValue() {            
                var setJObject = {"V" : seekbar.value};            
                var setRequestObject = new Object();

                setRequestObject.request = new XMLHttpRequest();
                setRequestObject.path = "/V";
                setRequestObject.body = JSON.stringify(setJObject);
                enqueue(setRequestObject);
            }

            function postTimings() {
                var timingstJObject = serializeTimings();

                if (timingstJObject == null) {
                    alert("Invalid time input for a timing!");
                    return;
                }

                var timingsRequestObject = new Object();

                timingsRequestObject.request = new XMLHttpRequest();
                timingsRequestObject.path = "/T";
                timingsRequestObject.body = JSON.stringify(timingstJObject);
                enqueue(timingsRequestObject);
            }

            function initMessages() {
                messages = document.getElementById("messages");
                for (var i = 0; i < NR_OF_MESSAGES; i++) {
                    var tr = document.createElement('tr');

                    tr.innerHTML =`<td style="width: 16%; text-align: center">${i+1}.</td>
                            <td style="width: 42%; text-align: left">-</td>
                            <td style="width: 42%; text-align: left">-</td>`;

                    messages.appendChild(tr);
                }   
            }

            function initTimings() {
                timings = document.getElementById("timings");

                for (var i = 0; i < NR_OF_TIMINGS; i++) {
                    var div = document.createElement('div');
                    div.style = "height:30px;";
                    div.innerHTML = `<p style="display:inline-block; padding-left: 2em;">${i+1}.</p>
                    <input id="timeSet${i}" type="time" style="display:inline-block; padding-left: 1em;">
                    <input type="checkbox" id="day${i}_0" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_0">M</label>
                    <input type="checkbox" id="day${i}_1" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_1">Tu</label>
                    <input type="checkbox" id="day${i}_2" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_2">W</label>
                    <input type="checkbox" id="day${i}_3" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_3">Th</label>
                    <input type="checkbox" id="day${i}_4" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_4">F</label>
                    <input type="checkbox" id="day${i}_5" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_5">Sa</label>
                    <input type="checkbox" id="day${i}_6" style="display:inline-block; padding-left: 1em;">
                    <label for="day${i}_6">Su</label>
                    <input type="range" min="0" max="100" name="V" id="tseekbar${i}" value="" style="display:inline-block;">
                    <div id="seekbarValue${i}" style="display:inline-block"></div> &nbsp;
                    <input type="checkbox" style="display:inline-block; padding-left: 1em;" id="toggle${i}">
                    <label for="toggle${i}">Active</label>`;
                    timings.appendChild(div);
                }

                for (var i = 0; i < NR_OF_TIMINGS; i++) {
                    var seekbar = document.getElementById(`tseekbar${i}`);
                    seekbar.customLabel = document.getElementById(`seekbarValue${i}`);
                    timingSeekbars.push(seekbar);                

                    timingSeekbars[i].oninput = function() {
                        this.customLabel.innerText = this.value;
                    };
                }
            }

            function serializeTimings() {
                var timingsObject = {};

                for(var i = 0; i < NR_OF_TIMINGS; i++) {
                    var timingObject = {};

                    var timeInput = document.getElementById(`timeSet${i}`).value;
                    var times = timeInput.split(":");

                    var days = "";

                    for (var j = 0; j < 7; j++) {
                        var dayBox = document.getElementById(`day${i}_${j}`);

                        if (dayBox.checked) {
                            days += "T";
                        }
                        else {
                            days += "F";
                        }
                    }

                    var activeBox = document.getElementById(`toggle${i}`);
                    var seekbar = document.getElementById(`tseekbar${i}`);

                    if (times[0] == null || times[1] == null) {
                        return null;
                    }

                    timingObject["H"] = parseInt(times[0]);
                    timingObject["M"] = parseInt(times[1]);
                    timingObject["D"] = days;
                    timingObject["A"] = activeBox.checked;
                    timingObject["V"] = parseInt(seekbar.value);

                    timingsObject[String(i)] =  timingObject;
                }

                return timingsObject;
            }

            function getFormattedMessage(T, R, A) {
                if (T == "E"){
                    return "-";
                }

                if (T == "I"){
                    return "Server startup.";
                }

                if (T == "J"){
                    return "JSON Error: " + R + ", " + A;
                }

                if (T == "Z"){
                    if (R == "F") {
                        return "Zeroing failed.";
                    }

                    if (R == "O") {
                        if (A == "U") {
                            return "Zeroing: up.";
                        }
                        else if (A == "D") {
                            return "Zeroing: down.";
                        }
                    }
                }

                if (T == "T") {
                    return "" + R + ". timing set: " + A + "%.";
                }

                if (T == "S") {
                    if (R == "M") {
                        return "Manual set: " + A + "%.";
                    }

                    if (R == "Z") {
                        return "Position found: " + A + "%.";
                    }

                    if (R == "T") {
                        return "Timings updated.";
                    }
                }

                return "Unknown event: " + T + ", " + R + ", " + A;
            }

            window.onload = function() {
                currentValue = document.getElementById("curVal");
                startup = document.getElementById("startup");
                stateMessage = document.getElementById("stat");

                seekbarValue = document.getElementById("seekbarValue");

                seekbar = document.getElementById("seekbar");
                seekbar.oninput = function() {
                    seekbarValue.innerText = seekbar.value;
                };

                timingButton = document.getElementById("timingButton");
                timingButton.onclick = postTimings;
                setButton = document.getElementById("setButton");
                setButton.onclick = postValue;
                upButton = document.getElementById("upButton");
                upButton.onclick = postUR;

                downButton = document.getElementById("downButton");
                downButton.onclick = postDR;
                autoButton = document.getElementById("autoButton");
                autoButton.onclick = postAR;

                initMessages();
                initTimings();
                disableGui();
                sendDumpRequest();

                var i = setInterval(function() {
                    if (queue.length == 0 && longrequest != true && currentRequest == null && failureCounter < 5) {
                        var statusRequestObject = createStatusRequestObject();
                        enqueue(statusRequestObject);
                    }
                }, 30000);
            };
        </script>
    </head>
    <body>
        <div style="display:inline-flex;">
            <h2 style="display:inline-block;">Shutter Controller!</h2>
            &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;
            <p style="display:inline-block;margin-top: 6%;margin-left:3em;">Hello USER_NAME!</p>
            &nbsp; &nbsp;
            <form action="./O">
                <input type="submit" style="display:inline-block; margin-top: 40%;" value="Sign out">
            </form>
        </div>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'set')">Set</button>
            <button class="tablinks" onclick="openTab(event, 'time')">Timing</button>
            <button class="tablinks" onclick="openTab(event, 'zero')">Zeroing</button>
        </div>

        <div id="set" class="tabcontent">
            <h5 style="height:0px;">Set: </h5>
            <div style="display:inline-flex;">
                <label for="fname">Set:</label><br>
                <input type="range" min="0" max="100" name="V" id="seekbar" value=""><br>
                <div id="seekbarValue"></div> &nbsp;
                <button id="setButton">Send</button>
            </div><br><br>
            <div style="display:inline-flex;">
                <div>Current value: &nbsp;</div>
                <div id="curVal"></div>
            </div><br><br>
        </div>

        <div id="time" class="tabcontent">
            <h5 style="height:0px;">Timings: </h5>

            <div id="timings">

            </div>
           
            <br>
            <br>
            <input type="submit" value="Send" style="margin-left: 2em;" id="timingButton">

        </div>

        <div id="zero" class="tabcontent">
            <h5 style="height: 10px;">Type of zeroing:</h5>
            <button id="upButton" style="margin-left: 2em">Up</button>
            <button id="downButton" style="margin-left: 2em">Down</button>
            <button id="autoButton" style="margin-left: 2em">Find</button>
            <br>
        </div>

        <div style="display:inline-flex;width: 100%;">
            <div style="width:40%;">
                <h5 style="height:0px;">Messages: </h5>
                <table style="width: 100%;" id="messages">
                    <tr>
                        <th style="width: 16%;">ID</th>
                        <th style="width: 32%; text-align: left;">Message</th>
                        <th style="width: 42%; text-align: left;">Time</th>
                    </tr>
                </table>
            </div>

            <div style="width:20%;">
                <br><br>
                <div style="display:inline-flex;">
                    <div>State: &nbsp; </div>
                    <div id="stat"></div>
                </div><br><br>

                <div style="display:inline-flex;">
                    <div>Startup: &nbsp; </div>
                    <div id="startup"></div>
                </div><br><br>
            </div>

        </div>
        <br>

        <script>
            function openTab(evt, cityName) {
              var i, tabcontent, tablinks;
              tabcontent = document.getElementsByClassName("tabcontent");
              for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
              }
              tablinks = document.getElementsByClassName("tablinks");
              for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
              }
              document.getElementById(cityName).style.display = "block";
              evt.currentTarget.className += " active";
            }
        </script>
    </body>
</html>